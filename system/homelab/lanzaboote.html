<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>Secure Boot & TPM-backed Full Disk Encryption on NixOS &#183; Jon Seager</title>
<meta name=title content="Secure Boot & TPM-backed Full Disk Encryption on NixOS &#183; Jon Seager"></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 print:hidden sm:py-10 dark:text-neutral"><nav class="flex items-start justify-between sm:items-center"><div class="z-40 flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Jon Seager</a></div><label id=menu-button for=menu-controller class="block sm:hidden"><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"><ul class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"><li class=mb-1><span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class="group mb-1"><a href=/posts/ title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Blog</span></a></li><li class="group mb-1"><a href=/cv/ title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">CV</span></a></li><li class="group mb-1"><a href=/colophon/ title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Meta</span></a></li><li class="group mb-1"><button id=appearance-switcher-1 type=button aria-label="appearance switcher">
<span class="group-dark:hover:text-primary-400 inline transition-colors group-hover:text-primary-600 dark:hidden" title="Switch to dark appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="group-dark:hover:text-primary-400 hidden transition-colors group-hover:text-primary-600 dark:inline" title="Switch to light appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li><li class="group mb-1"><button id=search-button-m0 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span></button></li></ul></div></label><ul class="hidden list-none flex-row text-end sm:flex"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/posts/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Blog</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/cv/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">CV</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/colophon/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Meta</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><button id=appearance-switcher-2 type=button aria-label="appearance switcher">
<span class="group-dark:hover:text-primary-400 inline transition-colors group-hover:text-primary-600 dark:hidden" title="Switch to dark appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="group-dark:hover:text-primary-400 hidden transition-colors group-hover:text-primary-600 dark:inline" title="Switch to light appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><button id=search-button-m1 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span></button></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 print:hidden dark:text-neutral-400"><li class="hidden inline"><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/></a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/posts/>Blog</a><span class="px-1 text-primary-500">/</span></li><li class="hidden inline"><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/2024/04/nixos-secure-boot-tpm-fde/>Secure Boot & TPM-backed Full Disk Encryption on NixOS</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Secure Boot & TPM-backed Full Disk Encryption on NixOS</h1><div class="mb-12 mt-8 text-base text-neutral-500 print:hidden dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2024-04-20 00:00:00 +0000 UTC">20 April 2024</time><span class="px-2 text-primary-500">&#183;</span><span>2887 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">14 mins</span></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#whats-a-tpm>What&rsquo;s a TPM?</a></li><li><a href=#secure-boot>Secure Boot</a></li><li><a href=#threat-modelling>Threat Modelling</a></li><li><a href=#enabling-secure-boot-on-nixos>Enabling Secure Boot on NixOS</a><ul><li><a href=#generating-secure-boot-keys>Generating Secure Boot Keys</a></li><li><a href=#enable-bootspec>Enable Bootspec</a></li><li><a href=#enable-lanzaboote>Enable <code>lanzaboote</code></a></li><li><a href=#prepare-the-uefi>Prepare the UEFI</a></li><li><a href=#enroll-secure-boot-keys>Enroll Secure Boot Keys</a></li><li><a href=#verify-secure-boot>Verify Secure Boot</a></li></ul></li><li><a href=#tpm-unlock-of-root-partition>TPM Unlock of Root Partition</a></li><li><a href=#useful-resources>Useful Resources</a></li><li><a href=#summary>Summary</a></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><blockquote><p><strong>Update</strong>: Since I wrote this post, I have been made aware of a particular situation where, at the time I write this (2025-01-17), the steps described in this article will result in a setup that is still (in many cases) vulnerable to an attack where the attacker has physical access to the machine. This may be acceptable in your threat model, but I&rsquo;d encourage you to read the <a href=https://oddlama.org/blog/bypassing-disk-encryption-with-tpm2-unlock/ target=_blank rel=noreferrer>excellent article</a> to gain a full understanding of the issue.</p></blockquote><h2 id=introduction class="relative group">Introduction <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#introduction aria-label=Anchor>#</a></span></h2><p>For the last decade (whoa&mldr;) or so, I&rsquo;ve defaulted to using LUKS-encrypted drives for my machines. In general, I configure an unencrypted boot/EFI partition, then place either an ext4 or btrfs filesystem inside a LUKS container which is used for the root partition.</p><p>Some of my machines also have extra disks: my desktop has a 1TB NVMe drive for root, and a 2TB NVMe &ldquo;data&rdquo; drive mounted in my home directory under <code>/home/jon/data</code>. I don&rsquo;t like having to type two different encryption passphrases at boot, so I usually have the extra disk automatically unlocked by putting the key in a file on the root drive, and placing an entry in <a href=https://www.man7.org/linux/man-pages/man5/crypttab.5.html target=_blank rel=noreferrer><code>/etc/crypttab</code></a>.</p><p>This setup works fine for desktop machines, but it&rsquo;s cumbersome on headless machines because unattended reboots require the disk passphrase to be entered at boot. Even then, all of my computers are exclusively used by me, and this setup means I have to enter two passwords on every boot to get to a working desktop environment (one for the disk, and one for the login manager).</p><p>I solved this recently with a combination of Secure Boot and a Trusted Platform Module (TPM), so let&rsquo;s look at those first with a brief and high-level overview of each.</p><h2 id=whats-a-tpm class="relative group">What&rsquo;s a TPM? <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#whats-a-tpm aria-label=Anchor>#</a></span></h2><p>Most machines that have been manufactured in the last decade, and certainly in the last 5 years, contain a cryptographic coprocessor conforming to the Trusted Platform Module (TPM) <a href=https://trustedcomputinggroup.org/resource/tpm-library-specification/ target=_blank rel=noreferrer>spec</a>. The TPM is a dedicated microcontroller primarily used for verifying the integrity of a machine.</p><p>TPMs can be used for storing cryptographic key material and performing basic cryptographic operations. The general premise is that keys can be loaded into the TPM, which enables the TPM to perform cryptographic operations using that key (signing, encrypting, etc.), but the key cannot be recovered or read from the TPM unless certain conditions are met. TPMs also provide other facilities such as secure random number generation, which in turn enables them to securely generate cryptographic keys.</p><p>Verifying system integrity essentially boils down to being able to ensure the machine hasn&rsquo;t been tampered with between boots, and that the boot process itself hasn&rsquo;t been compromised. A given firmware or operating system can take hardware &ldquo;measurements&rdquo; and store those measurements in dedicated slots called Platform Configuration Registers (PCRs). The measurements pertain to the underlying hardware and configuration of the machine. The TPM itself never performs the actual verification of the PCRs, and in fact has no knowledge of whether a measurement is inherently &ldquo;good&rdquo; or &ldquo;bad&rdquo;, but it can provide signed attestations of their values, which are then judged by the application requesting the attestation according to some policy.</p><p>Each PCR contains a hash representing a particular hardware measurement, which can be read at any time, but cannot be overwritten. Rather than allowing a traditional write operation, PCRs are updated through an &ldquo;extend&rdquo; operation which depends on the previous hash value, creating a chain of trust not dissimilar from how a blockchain is formed. This means that a given measurement can never be fully removed from the TPM.</p><p>Once the measurements are stored in the PCRs, there are various times and purposes for which the firmware or an operating system might read them - one example is for <a href=https://www.gradient.tech/faq-items/what-are-platform-configuration-registers-pcrs/ target=_blank rel=noreferrer>remote attestation</a> during login to a system. In this scenario the attestation can be used to verify that the machine hasn&rsquo;t been tampered with (perhaps in an <a href=https://en.wikipedia.org/wiki/Evil_maid_attack target=_blank rel=noreferrer>Evil Maid</a> attack). One could also store a Certificate Authority signing key in a TPM, and have the Certificate Authority software interface with the TPM to sign certificates using the <a href=https://en.wikipedia.org/wiki/PKCS_11 target=_blank rel=noreferrer>PKCS#11 standard</a>.</p><p>My use-case is to enabling the TPM to provide the passphrase to unlock a LUKS-encrypted disk, which is what I&rsquo;ll focus on in this post.</p><h2 id=secure-boot class="relative group">Secure Boot <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#secure-boot aria-label=Anchor>#</a></span></h2><p>Secure Boot is the mechanism by which the code executed by a machine&rsquo;s <a href=https://en.wikipedia.org/wiki/UEFI target=_blank rel=noreferrer>Unified Extensible Firmware Interface (UEFI)</a> can be verified as trusted. In the vast majority of cases, the first thing executed by the UEFI is a bootloader.</p><p>When Secure Boot is enabled, each binary executed by the UEFI must contain a checksum and a signature - which the UEFI verifies before launching the code. In the case that either the checksum or signature do not match, the UEFI will refuse the execute the code, and the boot process will halt.</p><p>Many OEM machines ship with Microsoft Windows installed, and thus ship with the necessary keys to validate signatures created with Microsoft&rsquo;s certificate authority. Linux systems are able to utilise these keys through <a href=https://github.com/rhboot/shim target=_blank rel=noreferrer><code>shim</code></a> - a small and easily verifiable piece of software which is signed by Microsoft. <code>shim</code> sits between the UEFI and the bootloader in the boot process, obviating the need for every Linux bootloader to be signed by Microsoft on every release. The shim is designed to <em>extend trust</em> from the keys trusted by the computer&rsquo;s firmware to a new set of keys controlled by the operating system.</p><p>But what does Secure Boot get us in reality? By signing the kernel, and in some cases a single UEFI PE binary known as a <a href=https://wiki.archlinux.org/title/Unified_kernel_image target=_blank rel=noreferrer>Unified Kernel Image (UKI)</a> (which contains the bootloader, the kernel, the command-line used to boot the kernel, and <a href=https://uapi-group.org/specifications/specs/unified_kernel_image/#uki-components target=_blank rel=noreferrer>other resources</a>), one can be reasonably sure that the boot process hasn&rsquo;t been tampered with.</p><p>This process thwarts a number of common physical attack vectors, such as <a href=https://linuxconfig.org/recover-reset-forgotten-linux-root-password target=_blank rel=noreferrer>manipulating the kernel command line to bypass the machine&rsquo;s login</a> and drop straight to a root shell - and combined with disk encryption can prevent offline data transfer from the machine. It also defends against malware which compromises the operating system&rsquo;s boot process such that it can start before the OS and obfuscate it&rsquo;s presence.</p><h2 id=threat-modelling class="relative group">Threat Modelling <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#threat-modelling aria-label=Anchor>#</a></span></h2><p>As with any security measure, Secure Boot is not a silver bullet. You should always consider your own personal threat model, and the sorts of attacks you&rsquo;re looking to defend against.</p><p>For example, Secure Boot can help prevent the sort of malware infections described in the previous section, but if an attacker gets physical access to your machine, and the UEFI isn&rsquo;t adequately protected, they could simply disable secure boot and carry on unhindered.</p><p>I mitigate this by password protecting the UEFI. This isn&rsquo;t perfect, but is likely sufficient protection for my threat model which is more about protecting chancers and petty thieves from gaining access to my information, than from determined attackers who gain physical access to my property.</p><p>Storing keys in a TPM is <em>theoretically</em> safe, in that each TPM has a unique seed which cannot be retrieved, and enables the TPM to deterministically generate keys between reboots. It&rsquo;s <em>very difficult</em> to retrieve the seed, and thus <em>very difficult</em> to duplicate a TPM, but not impossible. Even then, the Linux kernel&rsquo;s communication with the TPM on-the-wire is unencrypted, and the same can be said for many other subsystems which use the TPM. A <a href=https://hackaday.com/2024/02/06/beating-bitlocker-in-43-seconds/ target=_blank rel=noreferrer>recent example</a> of this vulnerability was demonstrated by sniffing a Bitlocker key off the <a href=https://en.wikipedia.org/wiki/Low_Pin_Count target=_blank rel=noreferrer>LPC bus</a> in a Lenovo X1 Carbon laptop (using a Raspberry Pi Pico, no less). In many modern machines this is mitigated by the TPM being on-CPU, but the point still stands.</p><p>I choose to enroll Microsoft&rsquo;s platform keys, which in theory degrades the security of my device in the case that Microsoft&rsquo;s signing key is compromised, though all of my machines are compatible with <code>fwupd</code> and can receive updates to the database through that mechanism if required (and in fact have done in the <a href=https://uefi.org/revocationlistfile/archive target=_blank rel=noreferrer>past 18 months</a>). This could be further mitigated by using custom keys and certificates for the full chain, but this is more overhead for daily operations and updates. It&rsquo;s also worth considering whether you have the resources to fully secure your own chain - especially by comparison to Microsoft who spend tens of millions of dollars per year on security. If an attacker wants your information, and are able to compromise Microsoft&rsquo;s CA, your own CA may not be such a hurdle.</p><p>Security measures are always a trade-off between Confidentiality, Availability and Integrity (CIA). In general, the more rigidly secure boot is implemented and configured, the more you&rsquo;re protecting confidentiality and integrity. The choices I&rsquo;ve made are slightly more in favour of availability, but nonetheless raise the bar for any attacker significantly.</p><h2 id=enabling-secure-boot-on-nixos class="relative group">Enabling Secure Boot on NixOS <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#enabling-secure-boot-on-nixos aria-label=Anchor>#</a></span></h2><p>Now for the fun part! The process for enabling Secure Boot on NixOS has simplified in recent months owing to the creation of <a href=https://github.com/nix-community/lanzaboote target=_blank rel=noreferrer><code>lanzaboote</code></a> - a project which takes of preparing and signing Unified Kernel Images containing a custom stub, the bootloader, the Linux kernel, the kernel&rsquo;s <code>initrd</code> and the kernel command line. <code>lanzaboote</code> also takes care of installing the UKI on the <a href=https://en.wikipedia.org/wiki/EFI_system_partition target=_blank rel=noreferrer>ESP partition</a> so the UEFI can execute it at boot.</p><p>The <code>lanzaboote</code> stub differs slightly from <a href=https://www.freedesktop.org/software/systemd/man/latest/systemd-stub.html target=_blank rel=noreferrer><code>systemd-stub</code></a>, in that it doesn&rsquo;t require the kernel and initrd to be part of the UKI. This is important for a generation-based operating system like NixOS because bundling the kernel and initrd into a new UKI for every generation would consume a lot of disk space, and quickly exhaust the ESP on most machines. In <code>lanzaboote</code>&rsquo;s implementation, the kernel and initrd are stored separately on the ESP, and the chain of trust is preserved by validating the signature of the kernel, and embedding a cryptographic hash of the initrd into the signed UKI.</p><p>The project takes advantage of systems that have <a href=https://github.com/NixOS/rfcs/blob/master/rfcs/0125-bootspec.md target=_blank rel=noreferrer>bootspec</a> enabled, which is a relatively recent NixOS RFC that ensures configured machines maintain a file containing a set of memoised facts about a system&rsquo;s closure. Bootspec aims to &ldquo;provide more uniform feature support&rdquo; to bootloaders in the NixOS ecosystem and &ldquo;enable NixOS users to implement custom bootloader tools and policy&rdquo; - of which <code>lanzaboote</code> is one.</p><h3 id=generating-secure-boot-keys class="relative group">Generating Secure Boot Keys <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#generating-secure-boot-keys aria-label=Anchor>#</a></span></h3><p>The first step is to generate some keys for the secure boot process. This can be achieved using the <a href="https://search.nixos.org/packages?channel=unstable&amp;show=sbctl&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=sbctl" target=_blank rel=noreferrer><code>sbctl</code> package</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>❯ sudo nix run nixpkgs#sbctl create-keys
</span></span><span class=line><span class=cl>Created Owner UUID 6ac34cc3-a23d-9745-ef33-a03f523d20a3
</span></span><span class=line><span class=cl>Creating secure boot keys...✓
</span></span><span class=line><span class=cl>Secure boot keys created!
</span></span></code></pre></td></tr></table></div></div><p>This should only take a few seconds at maximum, and will result in a set of keys being populated in <code>/etc/secureboot</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>❯ tree /etc/secureboot
</span></span><span class=line><span class=cl>/etc/secureboot
</span></span><span class=line><span class=cl>├── files.db
</span></span><span class=line><span class=cl>├── GUID
</span></span><span class=line><span class=cl>└── keys
</span></span><span class=line><span class=cl>   ├── db
</span></span><span class=line><span class=cl>   │  ├── db.key
</span></span><span class=line><span class=cl>   │  └── db.pem
</span></span><span class=line><span class=cl>   ├── dbx
</span></span><span class=line><span class=cl>   │  ├── dbx.key
</span></span><span class=line><span class=cl>   │  └── dbx.pem
</span></span><span class=line><span class=cl>   ├── KEK
</span></span><span class=line><span class=cl>   │  ├── KEK.key
</span></span><span class=line><span class=cl>   │  └── KEK.pem
</span></span><span class=line><span class=cl>   └── PK
</span></span><span class=line><span class=cl>      ├── PK.key
</span></span><span class=line><span class=cl>      └── PK.pem
</span></span></code></pre></td></tr></table></div></div><h3 id=enable-bootspec class="relative group">Enable Bootspec <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#enable-bootspec aria-label=Anchor>#</a></span></h3><p>Ensure that <code>bootspec</code> is enabled in your Nix configuration. You can see this in my flake for my desktop machine <a href=https://github.com/jnsgruk/nixos-config/blob/e436e046f19c76fcea0ac2570e7a747153c02ad5/host/kara/boot.nix#L5 target=_blank rel=noreferrer>on Github</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>boot</span><span class=o>.</span><span class=n>bootspec</span><span class=o>.</span><span class=n>enabled</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=enable-lanzaboote class="relative group">Enable <code>lanzaboote</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#enable-lanzaboote aria-label=Anchor>#</a></span></h3><p>I use a <a href=https://nixos.wiki/wiki/Flakes target=_blank rel=noreferrer>flake</a> to configure all of my machines, so I&rsquo;m able to get access to <code>lanzaboote</code> by adding the upstream flake as <a href=https://github.com/jnsgruk/nixos-config/blob/e436e046f19c76fcea0ac2570e7a747153c02ad5/flake.nix#L25-L26 target=_blank rel=noreferrer>an input</a> to my own <a href=https://github.com/jnsgruk/nixos-config target=_blank rel=noreferrer>nixos-config flake</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=err>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>lanzaboote</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;github:nix-community/lanzaboote&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span></code></pre></td></tr></table></div></div><p>Once you&rsquo;ve added <code>lanzaboote</code> as a dependency, you&rsquo;ll need to import the <code>lanzaboote</code> module:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=n>imports</span> <span class=err>=</span> <span class=p>[</span> <span class=n>lanzaboote</span><span class=o>.</span><span class=n>nixosModules</span><span class=o>.</span><span class=n>lanzaboote</span> <span class=p>];</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span></code></pre></td></tr></table></div></div><p>In my flake, I use a custom <a href=https://github.com/jnsgruk/nixos-config/blob/e436e046f19c76fcea0ac2570e7a747153c02ad5/lib/helpers.nix#L39 target=_blank rel=noreferrer>helper function</a> to build NixOS configurations, so the module is <a href=https://github.com/jnsgruk/nixos-config/blob/e436e046f19c76fcea0ac2570e7a747153c02ad5/lib/helpers.nix#L59 target=_blank rel=noreferrer>passed directly</a> to <code>lib.nixosSystem</code> through the <code>modules</code> attribute.</p><p>The <code>lanzaboote</code> module replaces the <code>systemd-boot</code> module, and as such you must explicitly <em>disable</em> <code>systemd-boot</code> when enabling <code>lanzaboote</code>. Additionally, if you wish to use the TPM for disk unlock (described in the next section), you must use the systemd initrd hooks (or something like <a href=https://github.com/latchset/clevis/ target=_blank rel=noreferrer><code>clevis</code></a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=n>boot</span> <span class=err>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>initrd</span><span class=o>.</span><span class=n>systemd</span><span class=o>.</span><span class=n>enable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>loader</span><span class=o>.</span><span class=n>systemd-boot</span><span class=o>.</span><span class=n>enable</span> <span class=o>=</span> <span class=n>lib</span><span class=o>.</span><span class=n>mkForce</span> <span class=no>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>lanzaboote</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pkiBundle</span> <span class=o>=</span> <span class=s2>&#34;/etc/secureboot&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>This is represented in my config <a href=https://github.com/jnsgruk/nixos-config/blob/e436e046f19c76fcea0ac2570e7a747153c02ad5/host/kara/boot.nix#L6-L10 target=_blank rel=noreferrer>here</a>.</p><p>Once enabled, rebuild your system (in my case with <code>sudo nixos-rebuild switch --flake /home/jon/nixos-config</code>) and verify that your machine is ready for Secure Boot. Don&rsquo;t panic about the kernel images being reported as not signed, this is expected:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>❯ sudo nix run unstable#sbctl verify
</span></span><span class=line><span class=cl>Verifying file database and EFI images in /boot...
</span></span><span class=line><span class=cl>✓ /boot/EFI/BOOT/BOOTX64.EFI is signed
</span></span><span class=line><span class=cl>✓ /boot/EFI/Linux/nixos-generation-414-376jna572gsb23snqs67t7s4bwxzb3epblmdnzweghuepopml2va.efi is signed
</span></span><span class=line><span class=cl>✓ /boot/EFI/Linux/nixos-generation-415-iqulgohymbdppgtxzho6ou3fcuxjbxhumpzm4vojmipwy3sbmuna.efi is signed
</span></span><span class=line><span class=cl>✓ /boot/EFI/Linux/nixos-generation-416-kxnzioafnduwwck3oypo7rqwtoat745czp2bpehoufp4yqiawypa.efi is signed
</span></span><span class=line><span class=cl>✗ /boot/EFI/nixos/kernel-6.8.2-242idodyvf36cpl6s5dskjy6mo4tjhszuwa3hye7qcjyuo5vnehq.efi is not signed
</span></span><span class=line><span class=cl>✗ /boot/EFI/nixos/kernel-6.8.5-zqulrwsucm6okcyns6v2jhh6fregk3bvsdth3yloqfymfbgnh64a.efi is not signed
</span></span><span class=line><span class=cl>✗ /boot/EFI/nixos/kernel-6.8.7-6mmixkr6ewywm5swgbi5ethbpgnyia4borzmkevcjx7n7t3mtida.efi is not signed
</span></span><span class=line><span class=cl>✓ /boot/EFI/systemd/systemd-bootx64.efi is signed
</span></span></code></pre></td></tr></table></div></div><h3 id=prepare-the-uefi class="relative group">Prepare the UEFI <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#prepare-the-uefi aria-label=Anchor>#</a></span></h3><p>Reboot your machine and enter the UEFI interface. This part of the process will vary from machine to machine depending on the UEFI implementation, but you&rsquo;re looking to enable Secure Boot, and clear the preloaded Secure Boot keys. This may be referred to as &ldquo;Setup Mode&rdquo;, or erasing the &ldquo;Platform Keys&rdquo;.</p><p>While you&rsquo;re here, I&rsquo;d also advise setting a UEFI password before rebooting back into NixOS.</p><h3 id=enroll-secure-boot-keys class="relative group">Enroll Secure Boot Keys <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#enroll-secure-boot-keys aria-label=Anchor>#</a></span></h3><p>The final stage in the process is to enroll your newly generated Secure Boot keys from step 1 into the UEFI. This is again achieved with <code>sbctl</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>❯ sudo nix run nixpkgs#sbctl enroll-keys -- --microsoft
</span></span><span class=line><span class=cl>Enrolling keys to EFI variables...
</span></span><span class=line><span class=cl>With vendor keys from microsoft...✓
</span></span><span class=line><span class=cl>Enrolled keys to the EFI variables!
</span></span></code></pre></td></tr></table></div></div><p>I chose to use the <code>--microsoft</code> option to also enroll the UEFI vendor certificates from Microsoft. Some systems contain firmware that is signed and validated when Secure Boot is enabled, and omitting the Microsoft keys could prevent your device from booting - omit this option with caution!</p><h3 id=verify-secure-boot class="relative group">Verify Secure Boot <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#verify-secure-boot aria-label=Anchor>#</a></span></h3><p>Once you&rsquo;ve enrolled the keys, reboot the machine back into NixOS and use <code>bootctl</code> to confirm that Secure Boot is in fact enabled:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>❯ bootctl status
</span></span><span class=line><span class=cl>System:
</span></span><span class=line><span class=cl>      Firmware: UEFI 2.80 <span class=o>(</span>American Megatrends 5.26<span class=o>)</span>
</span></span><span class=line><span class=cl> Firmware Arch: x64
</span></span><span class=line><span class=cl>   Secure Boot: enabled <span class=o>(</span>user<span class=o>)</span>
</span></span><span class=line><span class=cl>  TPM2 Support: yes
</span></span><span class=line><span class=cl>  Boot into FW: supported
</span></span></code></pre></td></tr></table></div></div><h2 id=tpm-unlock-of-root-partition class="relative group">TPM Unlock of Root Partition <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#tpm-unlock-of-root-partition aria-label=Anchor>#</a></span></h2><p>Now that we&rsquo;re (reasonably) confident that no one can tamper with the boot process, we can progress to allowing the machine to auto-unlock the encrypted disk using a key stored in the TPM.</p><p>This is actually more common than you might think - Windows has enabled this behaviour by default for some time with Bitlocker disk encryption, and Canonical is also <a href=https://ubuntu.com/blog/tpm-backed-full-disk-encryption-is-coming-to-ubuntu target=_blank rel=noreferrer>working on</a> bringing TPM-backed full disk encryption to Ubuntu.</p><p>This is probably the easiest step of them all! A simple invocation of <code>systemd-cryptenroll</code> is all that&rsquo;s required. The arguments below instruct the machine that PCRs 0, 2, 7 and 12 should be measured and verified before the TPM is allowed to unlock the disk.</p><p>According to the <a href=https://uapi-group.org/specifications/specs/linux_tpm_pcr_registry/ target=_blank rel=noreferrer>Linux TPM PCR Regsitry</a>, this means the following are measured before the LUKS key is presented:</p><ul><li>PCR 0: Core system firmware executable code</li><li>PCR 2: Extended or pluggable executable code</li><li>PCR 7: SecureBoot state</li><li>PCR 12: Kernel command line, system credentials and system configuration images</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>❯ sudo systemd-cryptenroll --tpm2-device<span class=o>=</span>auto --tpm2-pcrs<span class=o>=</span>0+2+7+12 --wipe-slot<span class=o>=</span>tpm2 /dev/nvme0n1p2
</span></span></code></pre></td></tr></table></div></div><p>And that&rsquo;s it! The next time you reboot, your disk should be automatically unlocked by the TPM, and your machine should boot straight to your display manager, or the TTY login if no display manager is configured.</p><h2 id=useful-resources class="relative group">Useful Resources <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#useful-resources aria-label=Anchor>#</a></span></h2><p>None of the knowledge in this post is novel, but rather the culmination of some knowledge acquired over the past few years, and some more targeted reading more recently. In the process, I learned a bunch from the following:</p><ul><li><a href=https://github.com/nix-community/lanzaboote target=_blank rel=noreferrer>Lanzaboote on Github</a></li><li><a href=https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot target=_blank rel=noreferrer>ArchWiki on UEFI Secure Boot</a></li><li><a href=https://discourse.nixos.org/t/full-disk-encryption-tpm2/29454 target=_blank rel=noreferrer>NixOS Discourse Post on TPM Unlock</a></li><li><a href=https://github.com/NixOS/rfcs/blob/master/rfcs/0125-bootspec.md target=_blank rel=noreferrer>Bootspec RFC</a></li><li><a href=https://fosdem.org/2024/schedule/event/fosdem-2024-1985-ukis-tpms-immutable-initrds-and-full-disk-encryption-what-distributions-should-keep-in-mind-when-hopping-onto-the-system-integrity-train/ target=_blank rel=noreferrer>Lennart Poettering&rsquo;s UKI Talk at FOSDEM 2024</a></li><li><a href=https://fosdem.org/2024/schedule/event/fosdem-2024-3141-linux-kernel-tpm-security-and-trusted-key-updates/ target=_blank rel=noreferrer>James Bottomley&rsquo;s TPM Talk at FOSDEM 2024</a>
<a href=https://ericchiang.github.io/post/tpm-keys/ target=_blank rel=noreferrer>The Trusted Platform Module Key Hierarchy</a></li></ul><h2 id=summary class="relative group">Summary <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#summary aria-label=Anchor>#</a></span></h2><p>About 5 years ago, I was sporting a fully secure-boot enabled Dell XPS 13 running Arch Linux. Back then, the process was complicated, manual, and required a lot of maintenance between upgrades. For me, it was more pain than gain, but an interesting learning experience nonetheless.</p><p>When I sat down earlier this year to enable Secure Boot on NixOS, I&rsquo;d set aside a few hours. I was astounded that 10 minutes later I was finished. I wrote this post as a memo to my future self, but also to illustrate how simple it can be to enable Secure Boot and TPM disk unlock in 2024.</p><p>I don&rsquo;t claim to be an expert on the inner workings of TPMs, nor Secure Boot. The things I can say for certain are that TPMs are complex, that there are improvements that could be made to Linux&rsquo;s interactions with the TPM, and that a determined and well-resourced attacker is likely going to succeed one way or another.</p><p>If you spot an inaccuracy in this post, reach out and let me know on Mastodon, on Telegram, by email, or however you prefer!</p><p>Until next time!</p><blockquote><p>Update 2024/04/29: Thanks to <a href=https://github.com/pimeys/ target=_blank rel=noreferrer>@pimeys</a> for pointing out that one must enable the systemd initrd hooks <code>systemd-cryptenroll</code> to function correctly, and also that PCR 12 must be measured to prevent the LUKS key from being released if the kernel command line has been modified.</p></blockquote></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><picture class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"><img width=1600 height=1600 class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full" alt="Jon Seager" loading=lazy decoding=async src=/img/author_hu3d111dc2308fa236e24e25d87c063d2d_261462_660x0_resize_q75_box.jpg srcset="/img/author_hu3d111dc2308fa236e24e25d87c063d2d_261462_330x0_resize_q75_box.jpg 330w,/img/author_hu3d111dc2308fa236e24e25d87c063d2d_261462_660x0_resize_q75_box.jpg 660w
,/img/author_hu3d111dc2308fa236e24e25d87c063d2d_261462_1024x0_resize_q75_box.jpg 1024w
,/img/author_hu3d111dc2308fa236e24e25d87c063d2d_261462_1320x0_resize_q75_box.jpg 1320w" sizes=100vw></picture><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Jon Seager</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Husband, father, leader, software engineer, geek.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/jnsgruk target=_blank aria-label=Github rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://hachyderm.io/@jnsgruk target=_blank aria-label=Mastodon rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://linkedin.com/in/jnsgruk target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://t.me/jnsgruk target=_blank aria-label=Telegram rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/2024/03/simplifying-snap-gui-testing/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Simplifying Test & Release of Snapped GUI Apps</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2024-03-18 00:00:00 +0000 UTC">18 March 2024</time>
</span></span></a></span><span><a class="group flex text-right" href=/2024/05/tracking-software-across-teams/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Tracking Releases & CI Across Software Teams and Forges</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2024-05-22 00:00:00 +0000 UTC">22 May 2024</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm sm:p-6 md:p-[10vh] lg:p-[12vh] dark:bg-neutral-900/50" data-url=https://jnsgr.uk/><div id=search-modal class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex flex-none items-center justify-between px-2"><form class="flex min-w-0 flex-auto items-center"><div class="flex h-8 w-8 items-center justify-center text-neutral-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto overflow-auto px-2"><ul id=search-results></ul></section></div></div></div></body></html>
